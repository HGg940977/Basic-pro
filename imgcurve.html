<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basic Touch Pro - Editor</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --hint: var(--tg-theme-hint-color, #707579);
            --btn: var(--tg-theme-button-color, #0088cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }

        body {
            font-family: sans-serif;
            margin: 0; background-color: var(--bg); color: var(--text);
            overflow: hidden;
        }

        .header {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: var(--bg); border-bottom: 1px solid var(--hint);
        }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo img { width: 30px; height: 30px; }
        .logo-text { font-weight: bold; font-size: 18px; color: var(--btn); }
        .profile { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--btn); }

        .editor-box {
            width: 100vw; height: calc(100vh - 160px);
            display: flex; align-items: center; justify-content: center;
            background: #d6d6d6; overflow: hidden;
        }
        #canvas-wrap {
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 10px 10px;
        }

        .toolbar {
            position: fixed; bottom: 0; width: 100%;
            background: var(--bg); border-top: 1px solid var(--hint);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .tools-scroll {
            display: flex; gap: 15px; overflow-x: auto; padding: 12px 15px;
            scrollbar-width: none; cursor: grab;
        }
        .tools-scroll::-webkit-scrollbar { display: none; }

        .tool-btn {
            display: flex; flex-direction: column; align-items: center;
            min-width: 55px; font-size: 11px; cursor: pointer;
        }
        .tool-btn i {
            width: 44px; height: 44px; background: var(--secondary);
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; font-size: 18px; margin-bottom: 5px; color: var(--btn);
        }

        #save-btn {
            background: var(--btn); color: var(--btn-text); border: none; 
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 12px;
            display: flex; align-items: center; gap: 5px;
        }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center; color: white;
        }

        .panel { padding: 10px 20px; background: var(--secondary); display: none; align-items: center; gap: 10px; }
        .panel input { flex: 1; }
    </style>
</head>
<body>

<div id="loading">
    <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--btn);"></i>
    <p id="load-msg">Please wait...</p>
</div>

<div class="header">
    <div class="logo">
        <img src="https://i.ibb.co/6c8B0DHm/20250728-114443.png" alt="Logo">
        <div class="logo-text">Basic Touch Pro</div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
        <button id="save-btn" onclick="handleFinalAction()">
            <i class="fas fa-check" id="final-icon"></i> <span id="final-text">DONE</span>
        </button>
        <img id="u-avatar" class="profile" src="https://ui-avatars.com/api/?name=User">
    </div>
</div>

<div class="editor-box">
    <div id="canvas-wrap">
        <canvas id="editor"></canvas>
    </div>
</div>

<div class="toolbar">
    <div class="panel" id="curve-ui">
        <input type="range" min="0" max="400" value="0" oninput="liveCurve(this.value)">
        <i class="fas fa-check-circle" onclick="document.getElementById('curve-ui').style.display='none'"></i>
    </div>

    <div class="tools-scroll" id="tools-scroll">
        <div class="tool-btn" onclick="document.getElementById('img-in').click()">
            <i class="fas fa-plus"></i>Add
        </div>
        <div class="tool-btn" onclick="centerLayer()">
            <i class="fas fa-align-center"></i>Center
        </div>
        <div class="tool-btn" onclick="makeCircle()">
            <i class="fas fa-circle"></i>Circle
        </div>
        <div class="tool-btn" onclick="document.getElementById('curve-ui').style.display='flex'">
            <i class="fas fa-vector-square"></i>Curve
        </div>
        <div class="tool-btn" onclick="moveLayer('up')">
            <i class="fas fa-layer-group"></i>Front
        </div>
        <div class="tool-btn" onclick="moveLayer('down')">
            <i class="fas fa-layer-group" style="transform:rotate(180deg)"></i>Back
        </div>
        <div class="tool-btn" onclick="removeBG()">
            <i class="fas fa-magic"></i>No BG
        </div>
        <div class="tool-btn" onclick="deleteLayer()" style="color:red">
            <i class="fas fa-trash" style="color:red"></i>Delete
        </div>
    </div>
</div>

<input type="file" id="img-in" style="display:none" accept="image/*">

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.BackButton.show();
    tg.BackButton.onClick(() => window.location.href = "index.html");

    function triggerAd() {
        // Ads logic if exists
    }

    const slider = document.getElementById('tools-scroll');
    let isDown = false; let startX; let scrollLeft;
    slider.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', () => isDown = false);
    slider.addEventListener('mouseup', () => isDown = false);
    slider.addEventListener('mousemove', (e) => {
        if(!isDown) return; e.preventDefault();
        const x = e.pageX - slider.offsetLeft;
        const walk = (x - startX) * 2; slider.scrollLeft = scrollLeft - walk;
    });

    fabric.Object.prototype.set({
        cornerSize: 16, touchCornerSize: 48,
        transparentCorners: false, cornerColor: '#0088cc', cornerStyle: 'circle'
    });

    const canvas = new fabric.Canvas('editor', { backgroundColor: null, preserveObjectStacking: true });
    let isFirst = true;
    let saveReady = false;

    if(tg.initDataUnsafe.user) {
        document.getElementById('u-avatar').src = `https://t.me/i/userpic/160/${tg.initDataUnsafe.user.username}.jpg`;
    }

    document.getElementById('img-in').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => {
            fabric.Image.fromURL(f.target.result, (img) => {
                if(isFirst) {
                    canvas.setWidth(img.width); canvas.setHeight(img.height);
                    const scale = Math.min((window.innerWidth * 0.9) / img.width, (window.innerHeight - 200) / img.height, 1);
                    document.getElementById('canvas-wrap').style.transform = `scale(${scale})`;
                    isFirst = false;
                }
                img.scaleToWidth(canvas.width * 0.6);
                img.set({ left: canvas.width/2, top: canvas.height/2, originX:'center', originY:'center' });
                canvas.add(img); canvas.setActiveObject(img);
            });
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function liveCurve(v) {
        const o = canvas.getActiveObject();
        if(o) { 
            o.set({ 
                clipPath: new fabric.Rect({ 
                    width: o.width, height: o.height, 
                    rx: v/o.scaleX, ry: v/o.scaleY, 
                    originX:'center', originY:'center' 
                }) 
            }); 
            canvas.renderAll(); 
        }
    }

    // New Circle Function
    function makeCircle() {
        const o = canvas.getActiveObject();
        if(!o) return;
        const radius = Math.min(o.width, o.height) / 2;
        o.set({
            clipPath: new fabric.Circle({
                radius: radius,
                originX: 'center',
                originY: 'center'
            })
        });
        canvas.renderAll();
    }

    function removeBG() {
        const o = canvas.getActiveObject();
        if(!o) return;
        tg.showConfirm("Processing will show an ad. Continue?", (ok) => {
            if(!ok) return;
            showL("Removing Background...");
            o.clone((cloned) => {
                const data = cloned.toDataURL();
                fetch(data).then(res => res.blob()).then(blob => {
                    const fd = new FormData();
                    fd.append('action', 'remove_bg');
                    fd.append('image_file', blob);
                    fetch(window.location.href, { method: 'POST', body: fd })
                    .then(r => r.text())
                    .then(base64 => {
                        fabric.Image.fromURL('data:image/png;base64,'+base64, (newImg) => {
                            newImg.set({ left: o.left, top: o.top, scaleX: o.scaleX, scaleY: o.scaleY, originX:'center', originY:'center' });
                            canvas.remove(o); canvas.add(newImg); hideL();
                        });
                    });
                });
            });
        });
    }

    function handleFinalAction() {
        if(!saveReady) {
            showL("Finalizing... Please wait");
            setTimeout(() => {
                hideL();
                document.getElementById('final-icon').className = "fas fa-download";
                document.getElementById('final-text').innerText = "SAVE";
                document.getElementById('save-btn').style.background = "#2eab5d";
                saveReady = true;
            }, 2000);
        } else {
            exportPNG();
        }
    }

    function exportPNG() {
        showL("Sending to Telegram...");
        canvas.discardActiveObject().renderAll();
        const data = canvas.toDataURL({ format: 'png', enableRetinaScaler: true });
        const fd = new FormData();
        fd.append('action', 'export_tg');
        fd.append('chat_id', tg.initDataUnsafe.user.id);
        fd.append('image_data', data);
        fetch(window.location.href, { method: 'POST', body: fd })
        .then(r => r.json()).then(res => { 
            hideL(); 
            if(res.ok) {
                tg.showAlert("Success! âœ…", () => {
                    window.location.href = "index.html";
                });
            } 
        });
    }

    function centerLayer() { const o = canvas.getActiveObject(); if(o){ o.center(); canvas.renderAll(); } }
    function moveLayer(d) { const o = canvas.getActiveObject(); if(o){ d==='up'?o.bringForward():o.sendBackwards(); canvas.renderAll(); } }
    function deleteLayer() { const o = canvas.getActiveObject(); if(o) canvas.remove(o); }
    function showL(m) { document.getElementById('loading').style.display='flex'; document.getElementById('load-msg').innerText=m; }
    function hideL() { document.getElementById('loading').style.display='none'; }
</script>


<script src="https://sad.adsgram.ai/js/sad.min.js"></script>

<script>
    window.addEventListener('load', function() {
        const AdController = window.Adsgram.init({ blockId: "int-19383" });

        AdController.show().then((result) => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
                
                setTimeout(() => {
                    window.Telegram.WebApp.showAlert('Thanks for support ðŸ’');
                }, 200);
            }
        }).catch((error) => {
            console.log(error);
        });
    });
</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"0b168fba841b4c6ba25d388460bf2e18","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>